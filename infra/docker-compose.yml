services:
  # -------------------------------------------------------
  # 1. The Mining Pool (MiningCore)
  # -------------------------------------------------------
  miningcore:
    build:
      context: .
      dockerfile: Dockerfile.pool
    image: community-pool/miningcore:latest
    restart: unless-stopped
    ports:
      - "3333:3333" # Stratum Port (Low Diff)
      - "4000:4000" # API Port
    volumes:
      - ../config/miningcore:/app/config
    depends_on:
      - postgres
      - redis
      - monero-node

  # -------------------------------------------------------
  # 2. Monero Node (The Blockchain)
  # -------------------------------------------------------
  monero-node:
    image: sethsimmons/simple-monerod:latest
    restart: unless-stopped
    volumes:
      - monero-data:/home/monero/.bitmonero
    ports:
      - "18080:18080" # P2P (External)
      # 18081 is RPC, we keep it internal for security
    command: >
      --rpc-bind-ip=0.0.0.0
      --rpc-bind-port=18081
      --confirm-external-bind
      --non-interactive
      --zmq-pub=tcp://0.0.0.0:18082 
      --out-peers=64
      --in-peers=32

  # -------------------------------------------------------
  # 3. Database (PostgreSQL)
  # -------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: miningcore
      POSTGRES_USER: miningcore
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_env_file}
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # -------------------------------------------------------
  # 4. Cache (Redis)
  # -------------------------------------------------------
  redis:
    image: redis:alpine
    restart: unless-stopped

# -------------------------------------------------------
  # 5. Monero Wallet RPC (Handles Payments)
  # -------------------------------------------------------
  monero-wallet:
    # CHANGED: Use the dedicated wallet image (not the daemon image)
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest 
    restart: unless-stopped
    # command: We keep the same flags, but now the binary actually exists!
    command: >
      --daemon-address monero-node:18081
      --rpc-bind-port 18083
      --rpc-bind-ip 0.0.0.0
      --wallet-dir /wallet
      --disable-rpc-login
      --confirm-external-bind
    volumes:
      - ./wallet:/wallet
    depends_on:
      - monero-node

volumes:
  monero-data:
  postgres-data:
  