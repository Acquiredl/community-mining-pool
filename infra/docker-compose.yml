services:
  # -------------------------------------------------------
  # 1. The Mining Pool (MiningCore)
  # -------------------------------------------------------
  miningcore:
    build:
      context: .
      dockerfile: Dockerfile.pool
    image: community-pool/miningcore:latest
    restart: unless-stopped
    ports:
      - "3333:3333"   # Stratum Port (Low Diff) - Monero
      - "3052:3052"   # Ergo Stratum - Low diff
      - "3152:3152"   # Ergo Stratum - High diff
      - "4000:4000"   # API Port
    volumes:
      - ../config/miningcore:/app/config
    depends_on:
      - postgres
      - redis
      - monero-node
      - monero-wallet
      - ergo-node

  # -------------------------------------------------------
  # 2. Monero Node (The Blockchain)
  # -------------------------------------------------------
  monero-node:
    image: ghcr.io/sethforprivacy/simple-monerod:latest
    restart: unless-stopped
    volumes:
      - monero-data:/home/monero/.bitmonero
    ports:
      - "18080:18080"   # P2P (External)
      - "18081:18081"   # RPC
      - "18082:18082"   # ZMQ
    command: >
      --rpc-bind-ip=0.0.0.0
      --rpc-bind-port=18081
      --confirm-external-bind
      --no-zmq
      --out-peers=64
      --in-peers=32

  # -------------------------------------------------------
  # 3. Database (PostgreSQL)
  # -------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: miningcore
      POSTGRES_USER: miningcore
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_env_file}
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # -------------------------------------------------------
  # 4. Cache (Redis)
  # -------------------------------------------------------
  redis:
    image: redis:alpine
    restart: unless-stopped

  # -------------------------------------------------------
  # 5. Monero Wallet RPC (Handles Payments)
  # -------------------------------------------------------
  monero-wallet:
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest
    restart: unless-stopped
    user: "0:0"
    volumes:
      - ./wallet:/wallet
    ports:
      - "18083:18083"
    entrypoint:
      - monero-wallet-rpc
      - --wallet-file
      - /wallet/poolwallet
      - --password
      - "buttpounder420"
      - --rpc-bind-port
      - "18083"
      - --rpc-bind-ip
      - "0.0.0.0"
      - --confirm-external-bind
      - --daemon-address
      - "monero-node:18081"
      - --trusted-daemon
      - --disable-rpc-login

  # -------------------------------------------------------
  # 6. Ergo Node (Autolykos2 / GPU Mining)
  # -------------------------------------------------------
  ergo-node:
    image: ergoplatform/ergo:latest
    container_name: ergo-node
    command: --mainnet -c /etc/ergo.conf
    volumes:
      - ergo-data:/home/ergo/.ergo
      - ./ergo.conf:/etc/ergo.conf:ro
    ports:
      - "9030:9030"     # P2P — blockchain sync with peers
      # 9053 NOT exposed — MiningCore connects internally via Docker DNS
    environment:
      - MAX_HEAP=4G
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9053/info || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  monero-data:
  monero-wallet:
  postgres-data:
  ergo-data: