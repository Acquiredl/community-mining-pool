services:
  # -------------------------------------------------------
  # 1. The Mining Pool (MiningCore)
  # -------------------------------------------------------
  miningcore:
    build:
      context: .
      dockerfile: Dockerfile.pool
    image: community-pool/miningcore:latest
    restart: unless-stopped
    ports:
      - "3333:3333"   # Stratum Port (Low Diff) - Monero
      - "3052:3052"   # Ergo Stratum - Low diff
      - "3152:3152"   # Ergo Stratum - High diff
      - "4000:4000"   # API Port
    volumes:
      - ../config/miningcore:/app/config
    depends_on:
      - postgres
      - redis
      - monero-node
      - monero-wallet
      - ergo-node

  # -------------------------------------------------------
  # 2. Monero Node (The Blockchain)
  # -------------------------------------------------------
  monero-node:
    image: ghcr.io/sethforprivacy/simple-monerod:latest
    restart: unless-stopped
    volumes:
      - monero-data:/home/monero/.bitmonero
    ports:
      - "18080:18080"   # P2P (External)
      - "18081:18081"   # RPC
      - "18082:18082"   # ZMQ
    command: >
      --rpc-bind-ip=0.0.0.0
      --rpc-bind-port=18081
      --confirm-external-bind
      --no-zmq
      --out-peers=64
      --in-peers=32
      --prune-blockchain

  # -------------------------------------------------------
  # 3. Database (PostgreSQL)
  # -------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: miningcore
      POSTGRES_USER: miningcore
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_env_file}
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # -------------------------------------------------------
  # 4. Cache (Redis)
  # -------------------------------------------------------
  redis:
    image: redis:alpine
    restart: unless-stopped

  # -------------------------------------------------------
  # 5. Monero Wallet RPC (Handles Payments)
  # -------------------------------------------------------
  monero-wallet:
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest
    restart: unless-stopped
    user: "0:0"
    volumes:
      - ./wallet:/wallet
    ports:
      - "18083:18083"
    depends_on:
      monero-node:
        condition: service_healthy
    entrypoint:
      - monero-wallet-rpc
      - --wallet-file
      - /wallet/poolwallet
      - --password
      - "buttpounder420"
      - --rpc-bind-port
      - "18083"
      - --rpc-bind-ip
      - "0.0.0.0"
      - --confirm-external-bind
      - --daemon-address
      - "monero-node:18081"
      - --trusted-daemon
      - --disable-rpc-login

  # -------------------------------------------------------
  # 6. Ergo Node (Autolykos2 / GPU Mining)
  # -------------------------------------------------------
  ergo-node:
    image: ergoplatform/ergo:latest
    container_name: ergo-node
    command: --mainnet -c /etc/ergo.conf
    volumes:
      - ergo-data:/home/ergo/.ergo
      - ./ergo.conf:/etc/ergo.conf:ro
    ports:
      - "9030:9030"     # P2P — blockchain sync with peers
      # 9053 NOT exposed — MiningCore connects internally via Docker DNS
    environment:
      - MAX_HEAP=4G
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9053/info || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # -------------------------------------------------------
  # 7. Frontend Dashboard (Nuxt 3) — PHASE 4A NEW
  # -------------------------------------------------------
  # This is the web UI that miners visit to check their stats.
  # It consumes the MiningCore REST API on port 4000.
  frontend:
    build:
      context: ../frontend           # Points to the frontend/ directory at repo root
      dockerfile: Dockerfile
    volumes:
    - ../config/pool-theme:/app/config
    image: community-pool/frontend:latest
    restart: unless-stopped
    ports:
      - "3000:3000"                  # Nuxt dev/production server
    environment:
      # NUXT_PUBLIC_API_URL — tells the frontend where MiningCore's API lives.
      # Inside Docker, services find each other by service name (not localhost).
      # "miningcore" here matches the service name above.
      - NUXT_PUBLIC_API_URL=/api

      # NUXT_PUBLIC_POOL_NAME — displayed in the navbar and page titles.
      # ${POOL_NAME} reads from your .env file. Falls back to default if not set.
      - NUXT_PUBLIC_POOL_NAME=${POOL_NAME:-Community Mining Pool}
    depends_on:
      - miningcore                   # Don't start frontend until pool engine is up

  # -------------------------------------------------------
  # 8. Reverse Proxy (Nginx) — PHASE 4A NEW
  # -------------------------------------------------------
  # Routes incoming web traffic:
  #   http://your-server/api/*  → MiningCore API (port 4000)
  #   http://your-server/*      → Nuxt Frontend (port 3000)
  #
  # In Phase 5, this will also handle SSL/TLS (HTTPS).
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"                      # HTTP — the port visitors hit in their browser
      # Uncomment in Phase 5 when you add SSL certificates:
      # - "443:443"
    volumes:
      # Mount your nginx config (read-only for security)
      - ../config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Uncomment in Phase 5 for SSL:
      # - ../config/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend                     # Nginx needs both backend services running
      - miningcore

volumes:
  monero-data:
  monero-wallet:
  postgres-data:
  ergo-data: