# ============================================================
# NGINX REVERSE PROXY
#
# Routes traffic:
#   /api/*  → MiningCore REST API (port 4000)
#   /*      → Nuxt 3 Frontend (port 3000)
#
# In Phase 5, this will also handle:
#   - SSL/TLS termination (Let's Encrypt)
#   - Rate limiting
#   - DDoS protection headers
# ============================================================

events {
    worker_connections 1024;
}

http {
    # --- Upstream Services ---
    upstream frontend {
        server frontend:3000;
    }

    upstream miningcore_api {
        server miningcore:4000;
    }

    # --- Rate Limiting ---
    # Prevent API abuse. 10 requests/second per IP.
    # Generous enough for dashboards, tight enough to block scrapers.
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name _;

        # --- Security Headers ---
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # --- MiningCore API ---
        # Proxy /api/* requests to MiningCore on port 4000
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://miningcore_api/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORS headers (allow frontend to call the API)
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;

            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }

        # --- Nuxt Frontend ---
        # Everything else goes to the Nuxt app
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (needed for Nuxt HMR in dev, and SSE in prod)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # --- Static Assets (Nuxt) ---
        # Cache static files aggressively
        location /_nuxt/ {
            proxy_pass http://frontend;
            proxy_cache_valid 200 7d;
            add_header Cache-Control "public, max-age=604800, immutable";
        }
    }

    # --- Phase 5: HTTPS Server Block ---
    # Uncomment when you have SSL certificates
    #
    # server {
    #     listen 443 ssl http2;
    #     server_name pool.example.com;
    #
    #     ssl_certificate     /etc/nginx/ssl/fullchain.pem;
    #     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    #
    #     # ... same location blocks as above ...
    # }
    #
    # # Redirect HTTP → HTTPS
    # server {
    #     listen 80;
    #     server_name pool.example.com;
    #     return 301 https://$host$request_uri;
    # }
}